const C=document.getElementById("productosGrid"),B=document.getElementById("busqueda");let y=[],c=[];async function j(){y=await(await fetch("https://fakestoreapi.com/products")).json(),w(y.slice(0,6))}function w(e){C.innerHTML="",e.forEach(t=>{const o=document.createElement("div");o.classList.add("product-card"),o.innerHTML=`
            <img src="${t.image}" alt="${t.title}">
            <h4>${t.title}</h4>
        `,o.addEventListener("click",()=>{c.find(n=>n.id===t.id)?(c=c.filter(n=>n.id!==t.id),o.classList.remove("selected")):c.length<4?(c.push({id:t.id,title:t.title,price:t.price,category:t.category,image:t.image}),o.classList.add("selected")):Swal.fire({icon:"warning",title:"Máximo 4 productos seleccionados",confirmButtonColor:"#f0ad4e"})}),C.appendChild(o)})}B.addEventListener("keyup",e=>{const t=e.target.value.toLowerCase(),o=y.filter(r=>r.title.toLowerCase().includes(t));w(o.slice(0,6))});j();const E=document.getElementById("formularioDatos"),d=document.getElementById("nombre"),m=document.getElementById("ocupacion"),f=document.getElementById("correo"),u=document.getElementById("edad"),L=document.getElementById("tipoCaja"),x=document.getElementById("frecuenciaCaja"),h={texto:/^[a-zA-ZÀ-ÿ\s]{6,40}$/,correo:/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/};function s(e,t){const o=e.parentElement,r=o.querySelector(".error-message");let n=!0;if(t==="texto"&&(h.texto.test(e.value.trim())?(r.textContent="",o.classList.remove("error")):(r.textContent="Solo se permiten letras y espacios, mínimo 6 caracteres.",o.classList.add("error"),n=!1)),t==="correo"&&(h.correo.test(e.value.trim())?(r.textContent="",o.classList.remove("error")):(r.textContent="Ingresa un correo válido (ej: usuario@dominio.com).",o.classList.add("error"),n=!1)),t==="edad"){const l=parseInt(e.value,10);isNaN(l)||l<18||l>100?(r.textContent="Ingresa un número válido entre 18 y 100.",o.classList.add("error"),n=!1):(r.textContent="",o.classList.remove("error"))}return n}[d,m,f,u].forEach(e=>{e.addEventListener("input",()=>{(e===d||e===m)&&s(e,"texto"),e===f&&s(e,"correo"),e===u&&s(e,"edad")}),e.addEventListener("blur",()=>{(e===d||e===m)&&s(e,"texto"),e===f&&s(e,"correo"),e===u&&s(e,"edad")})});E.addEventListener("submit",async e=>{e.preventDefault();const t=s(d,"texto"),o=s(m,"texto"),r=s(f,"correo"),n=s(u,"edad");if(!t||!o||!r||!n){Swal.fire({icon:"warning",title:"Corrige los errores en el formulario",confirmButtonColor:"#f0ad4e"});return}if(c.length===0){Swal.fire({icon:"warning",title:"Selecciona al menos un producto",confirmButtonColor:"#f0ad4e"});return}if(!L.value||!x.value){Swal.fire({icon:"warning",title:"Selecciona tipo de caja y frecuencia",confirmButtonColor:"#f0ad4e"});return}const l={nombre:d.value,ocupacion:m.value,correo:f.value,edad:u.value,tipoCaja:L.value,frecuenciaCaja:x.value,productos:c.map(a=>({id:a.id,title:a.title,price:a.price,category:a.category,image:a.image}))};try{const a=await fetch("/api/contacto",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(l)}),g=await a.json();if(!a.ok){if(a.status===422&&g.errors){const v=g.errors;Object.keys(v).forEach(p=>{const i=document.getElementById(`error-${p}`);i&&(i.textContent=v[p][0],i.style.display="block",i.parentElement.classList.add("error"),setTimeout(()=>{i.style.display="none",i.textContent="",i.parentElement.classList.remove("error")},5e3))})}else Swal.fire({icon:"error",title:"Oops...",text:g.mensaje||"Hubo un error al enviar los datos",confirmButtonColor:"#d33"});return}Swal.fire({icon:"success",title:"¡Perfecto!",text:g.mensaje||"Datos enviados correctamente",confirmButtonColor:"#007bff"}),E.reset(),c=[],document.querySelectorAll(".product-card.selected").forEach(v=>v.classList.remove("selected"))}catch(a){console.error("Error al enviar datos:",a),Swal.fire({icon:"error",title:"Oops...",text:"Hubo un error al enviar los datos",confirmButtonColor:"#d33"})}});document.addEventListener("DOMContentLoaded",async()=>{const e=localStorage.getItem("token"),t=document.getElementById("perfilLink");if(e)try{const r=await(await fetch("/api/usuario",{headers:{"X-Api-Token":e,Accept:"application/json"}})).json();t&&(t.innerHTML=`<i class="fa fa-user"></i> ${r.nombre}`,t.href="/perfil")}catch(o){console.error(o),localStorage.removeItem("token")}});
