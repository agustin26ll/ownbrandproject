const E=document.getElementById("productosGrid"),w=document.getElementById("busqueda");let v=[],n=[];async function B(){v=await(await fetch("https://fakestoreapi.com/products")).json(),C(v.slice(0,6))}function C(e){E.innerHTML="",e.forEach(t=>{const o=document.createElement("div");o.classList.add("product-card"),o.innerHTML=`
            <img src="${t.image}" alt="${t.title}">
            <h4>${t.title}</h4>
        `,o.addEventListener("click",()=>{n.find(s=>s.id===t.id)?(n=n.filter(s=>s.id!==t.id),o.classList.remove("selected")):n.length<4?(n.push({id:t.id,title:t.title,price:t.price,category:t.category,image:t.image}),o.classList.add("selected")):Swal.fire({icon:"warning",title:"Máximo 4 productos seleccionados",confirmButtonColor:"#f0ad4e"})}),E.appendChild(o)})}w.addEventListener("keyup",e=>{const t=e.target.value.toLowerCase(),o=v.filter(r=>r.title.toLowerCase().includes(t));C(o.slice(0,6))});B();const L=document.getElementById("formularioDatos"),d=document.getElementById("nombre"),m=document.getElementById("ocupacion"),f=document.getElementById("correo"),u=document.getElementById("edad"),p={texto:/^[a-zA-ZÀ-ÿ\s]{6,40}$/,correo:/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/};function a(e,t){const o=e.parentElement,r=o.querySelector(".error-message");let s=!0;if(t==="texto"&&(p.texto.test(e.value.trim())?(r.textContent="",o.classList.remove("error")):(r.textContent="Solo se permiten letras y espacios, mínimo 6 caracteres.",o.classList.add("error"),s=!1)),t==="correo"&&(p.correo.test(e.value.trim())?(r.textContent="",o.classList.remove("error")):(r.textContent="Ingresa un correo válido (ej: usuario@dominio.com).",o.classList.add("error"),s=!1)),t==="edad"){const i=parseInt(e.value,10);isNaN(i)||i<18||i>100?(r.textContent="Ingresa un número válido entre 18 y 100.",o.classList.add("error"),s=!1):(r.textContent="",o.classList.remove("error"))}return s}[d,m,f,u].forEach(e=>{e.addEventListener("input",()=>{(e===d||e===m)&&a(e,"texto"),e===f&&a(e,"correo"),e===u&&a(e,"edad")}),e.addEventListener("blur",()=>{(e===d||e===m)&&a(e,"texto"),e===f&&a(e,"correo"),e===u&&a(e,"edad")})});L.addEventListener("submit",async e=>{e.preventDefault();const t=a(d,"texto"),o=a(m,"texto"),r=a(f,"correo"),s=a(u,"edad");if(!t||!o||!r||!s){Swal.fire({icon:"warning",title:"Corrige los errores en el formulario",confirmButtonColor:"#f0ad4e"});return}if(n.length===0){Swal.fire({icon:"warning",title:"Selecciona al menos un producto",confirmButtonColor:"#f0ad4e"});return}const i={nombre:d.value,ocupacion:m.value,correo:f.value,edad:u.value,productos:n};try{const l=await fetch("/api/contacto",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(i)});if(l.status===422){const y=(await l.json()).errors;Object.keys(y).forEach(x=>{const c=document.getElementById(`error-${x}`);c&&(c.textContent=y[x][0],c.style.display="block",c.parentElement.classList.add("error"),setTimeout(()=>{c.style.display="none",c.textContent="",c.parentElement.classList.remove("error")},5e3))});return}const h=await l.json();Swal.fire({icon:"success",title:"¡Perfecto!",text:h.mensaje||"Datos enviados correctamente",confirmButtonColor:"#007bff"}),L.reset(),n=[],document.querySelectorAll(".product-card.selected").forEach(g=>g.classList.remove("selected"))}catch(l){console.error("Error al enviar datos:",l),Swal.fire({icon:"error",title:"Oops...",text:"Hubo un error al enviar los datos",confirmButtonColor:"#d33"})}});
