const E=document.getElementById("productosGrid"),h=document.getElementById("busqueda");let y=[],c=[];async function w(){y=await(await fetch("https://fakestoreapi.com/products")).json(),p(y.slice(0,6))}function p(e){E.innerHTML="",e.forEach(t=>{const o=document.createElement("div");o.classList.add("product-card"),o.innerHTML=`
            <img src="${t.image}" alt="${t.title}">
            <h4>${t.title}</h4>
        `,o.addEventListener("click",()=>{c.find(a=>a.id===t.id)?(c=c.filter(a=>a.id!==t.id),o.classList.remove("selected")):c.length<4?(c.push({id:t.id,title:t.title,price:t.price,category:t.category,image:t.image}),o.classList.add("selected")):Swal.fire({icon:"warning",title:"Máximo 4 productos seleccionados",confirmButtonColor:"#f0ad4e"})}),E.appendChild(o)})}h.addEventListener("keyup",e=>{const t=e.target.value.toLowerCase(),o=y.filter(r=>r.title.toLowerCase().includes(t));p(o.slice(0,6))});w();const L=document.getElementById("formularioDatos"),d=document.getElementById("nombre"),m=document.getElementById("ocupacion"),f=document.getElementById("correo"),u=document.getElementById("edad"),C={texto:/^[a-zA-ZÀ-ÿ\s]{6,40}$/,correo:/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/};function n(e,t){const o=e.parentElement,r=o.querySelector(".error-message");let a=!0;if(t==="texto"&&(C.texto.test(e.value.trim())?(r.textContent="",o.classList.remove("error")):(r.textContent="Solo se permiten letras y espacios, mínimo 6 caracteres.",o.classList.add("error"),a=!1)),t==="correo"&&(C.correo.test(e.value.trim())?(r.textContent="",o.classList.remove("error")):(r.textContent="Ingresa un correo válido (ej: usuario@dominio.com).",o.classList.add("error"),a=!1)),t==="edad"){const l=parseInt(e.value,10);isNaN(l)||l<18||l>100?(r.textContent="Ingresa un número válido entre 18 y 100.",o.classList.add("error"),a=!1):(r.textContent="",o.classList.remove("error"))}return a}[d,m,f,u].forEach(e=>{e.addEventListener("input",()=>{(e===d||e===m)&&n(e,"texto"),e===f&&n(e,"correo"),e===u&&n(e,"edad")}),e.addEventListener("blur",()=>{(e===d||e===m)&&n(e,"texto"),e===f&&n(e,"correo"),e===u&&n(e,"edad")})});L.addEventListener("submit",async e=>{e.preventDefault();const t=n(d,"texto"),o=n(m,"texto"),r=n(f,"correo"),a=n(u,"edad");if(!t||!o||!r||!a){Swal.fire({icon:"warning",title:"Corrige los errores en el formulario",confirmButtonColor:"#f0ad4e"});return}if(c.length===0){Swal.fire({icon:"warning",title:"Selecciona al menos un producto",confirmButtonColor:"#f0ad4e"});return}const l={nombre:d.value,ocupacion:m.value,correo:f.value,edad:u.value,productos:c.map(s=>({id:s.id,title:s.title,price:s.price,category:s.category,image:s.image}))};try{const s=await fetch("/api/contacto",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(l)}),g=await s.json();if(!s.ok){if(s.status===422&&g.errors){const v=g.errors;Object.keys(v).forEach(x=>{const i=document.getElementById(`error-${x}`);i&&(i.textContent=v[x][0],i.style.display="block",i.parentElement.classList.add("error"),setTimeout(()=>{i.style.display="none",i.textContent="",i.parentElement.classList.remove("error")},5e3))})}else Swal.fire({icon:"error",title:"Oops...",text:g.mensaje||"Hubo un error al enviar los datos",confirmButtonColor:"#d33"});return}Swal.fire({icon:"success",title:"¡Perfecto!",text:g.mensaje||"Datos enviados correctamente",confirmButtonColor:"#007bff"}),L.reset(),c=[],document.querySelectorAll(".product-card.selected").forEach(v=>v.classList.remove("selected"))}catch(s){console.error("Error al enviar datos:",s),Swal.fire({icon:"error",title:"Oops...",text:"Hubo un error al enviar los datos",confirmButtonColor:"#d33"})}});
